-- V1.1.1__Initial_Schema.sql
-- Create schemas and tables for CoinDesk and NewHedge data

-- =====================================================
-- SCHEMA CREATION
-- =====================================================

-- Create CoinDesk schema
CREATE SCHEMA IF NOT EXISTS COINDESK;

-- Create NewHedge schema
CREATE SCHEMA IF NOT EXISTS NEWHEDGE;

-- =====================================================
-- COINDESK SCHEMA - Move existing tables to schema
-- =====================================================

-- 1. Historical Daily Data
CREATE OR REPLACE TABLE COINDESK.HISTODAY (
    TIME NUMBER(38,0),
    OPEN FLOAT,
    HIGH FLOAT,
    LOW FLOAT,
    CLOSE FLOAT,
    VOLUME FLOAT,
    PRIMARY KEY (TIME)
);

-- 2. Historical Hourly Data
CREATE OR REPLACE TABLE COINDESK.HISTOHOUR (
    TIME NUMBER(38,0),
    OPEN FLOAT,
    HIGH FLOAT,
    LOW FLOAT,
    CLOSE FLOAT,
    VOLUME FLOAT,
    PRIMARY KEY (TIME)
);

-- 3. Blockchain Balance Distribution (Flattened)
CREATE OR REPLACE TABLE COINDESK.BLOCKCHAIN_BALANCEDISTRIBUTION (
    MERGE_KEY STRING,
    TIME NUMBER(38,0),
    SYMBOL STRING,
    PARTNER_SYMBOL STRING,
    ID NUMBER,
    ADDRESSESCOUNT NUMBER,
    "FROM" FLOAT,
    "TO" FLOAT,
    TOTALVOLUME FLOAT,
    PRIMARY KEY (MERGE_KEY)
);

-- 4. Price Multi Full Snapshots
CREATE OR REPLACE TABLE COINDESK.PRICEMULTIFULL (
    TYPE STRING,
    MARKET STRING,
    FROMSYMBOL STRING,
    TOSYMBOL STRING,
    FLAGS STRING,
    LASTMARKET STRING,
    MEDIAN FLOAT,
    TOPTIERVOLUME24HOUR FLOAT,
    TOPTIERVOLUME24HOURTO FLOAT,
    LASTTRADEID STRING,
    PRICE FLOAT,
    LASTUPDATE NUMBER,
    LASTVOLUME FLOAT,
    LASTVOLUMETO FLOAT,
    VOLUMEHOUR FLOAT,
    VOLUMEHOURTO FLOAT,
    OPENHOUR FLOAT,
    HIGHHOUR FLOAT,
    LOWHOUR FLOAT,
    VOLUMEDAY FLOAT,
    VOLUMEDAYTO FLOAT,
    OPENDAY FLOAT,
    HIGHDAY FLOAT,
    LOWDAY FLOAT,
    VOLUME24HOUR FLOAT,
    VOLUME24HOURTO FLOAT,
    OPEN24HOUR FLOAT,
    HIGH24HOUR FLOAT,
    LOW24HOUR FLOAT,
    CHANGE24HOUR FLOAT,
    CHANGEPCT24HOUR FLOAT,
    CHANGEDAY FLOAT,
    CHANGEPCTDAY FLOAT,
    CHANGEHOUR FLOAT,
    CHANGEPCTHOUR FLOAT,
    CONVERSIONTYPE STRING,
    CONVERSIONSYMBOL STRING,
    CONVERSIONLASTUPDATE NUMBER,
    SUPPLY FLOAT,
    MKTCAP FLOAT,
    MKTCAPPENALTY NUMBER,
    CIRCULATINGSUPPLY FLOAT,
    CIRCULATINGSUPPLYMKTCAP FLOAT,
    TOTALVOLUME24H FLOAT,
    TOTALVOLUME24HTO FLOAT,
    TOTALTOPTIERVOLUME24H FLOAT,
    TOTALTOPTIERVOLUME24HTO FLOAT,
    IMAGEURL STRING,
    FETCHED_AT TIMESTAMP_TZ DEFAULT CURRENT_TIMESTAMP()
);

-- 5. News Data
CREATE OR REPLACE TABLE COINDESK.NEWS (
    ID NUMBER,
    GUID STRING,
    PUBLISHED_ON NUMBER,
    IMAGEURL STRING,
    TITLE STRING,
    URL STRING,
    SOURCE STRING,
    BODY STRING,
    TAGS STRING,
    CATEGORIES STRING,
    UPVOTES NUMBER,
    DOWNVOTES NUMBER,
    LANG STRING,
    SOURCE_INFO VARIANT,
    FETCHED_AT TIMESTAMP_TZ DEFAULT CURRENT_TIMESTAMP(),
    PRIMARY KEY (ID)
);

-- 6. Hourly Social Data
CREATE OR REPLACE TABLE COINDESK.HOURLY_SOCIAL_DATA (
    TIME NUMBER(38,0),
    REDDIT_ACTIVE_USERS NUMBER,
    REDDIT_POSTS_PER_HOUR FLOAT,
    REDDIT_COMMENTS_PER_HOUR FLOAT,
    REDDIT_POSTS_PER_DAY FLOAT,
    REDDIT_COMMENTS_PER_DAY FLOAT,
    TWITTER_FOLLOWERS NUMBER,
    TWITTER_FAVOURITES NUMBER,
    TWITTER_STATUSES NUMBER,
    FETCHED_AT TIMESTAMP_TZ DEFAULT CURRENT_TIMESTAMP(),
    PRIMARY KEY (TIME)
);

-- 7. Trading Signals (Flattened)
CREATE OR REPLACE TABLE COINDESK.TRADINGSIGNALS (
    INOUTVAR_SENTIMENT STRING,
    INOUTVAR_VALUE FLOAT,
    LTHANDSTH_SENTIMENT STRING,
    LTHANDSTH_VALUE FLOAT,
    CONCENTRATION_SENTIMENT STRING,
    CONCENTRATION_VALUE FLOAT,
    LARGESURPLUS_SENTIMENT STRING,
    LARGESURPLUS_VALUE FLOAT,
    FETCHED_AT TIMESTAMP_TZ DEFAULT CURRENT_TIMESTAMP()
);

-- =====================================================
-- NEWHEDGE SCHEMA - Normalized table structure
-- =====================================================

-- Table 1: Market Data (Core price and market metrics)
CREATE OR REPLACE TABLE NEWHEDGE.MARKET_DATA (
    TIMESTAMP TIMESTAMP_TZ,
    -- Price metrics
    LIVE_PRICE FLOAT,
    MARKET_CAP FLOAT,
    BTC_DOMINANCE_PCT FLOAT,
    SATS_PER_DOLLAR INTEGER,
    -- 24h metrics
    HIGH_24H FLOAT,
    LOW_24H FLOAT,
    VOL_BTC_24H FLOAT,
    VOL_USD_24H FLOAT,
    -- Performance metrics
    DAILY_PERFORMANCE_PCT FLOAT,
    WEEKLY_PERFORMANCE_PCT FLOAT,
    MONTHLY_PERFORMANCE_PCT FLOAT,
    QUARTERLY_PERFORMANCE_PCT FLOAT,
    -- ATH metrics
    ATH_PRICE_USD FLOAT,
    ATH_DATE DATE,
    DAYS_SINCE_ATH INTEGER,
    PRICE_DRAWDOWN_PCT FLOAT,
    -- Fear & Greed
    FEAR_GREED_INDEX_VALUE FLOAT,
    FEAR_GREED_LABEL STRING,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 2: Blockchain Metrics (Network and block data)
CREATE OR REPLACE TABLE NEWHEDGE.BLOCKCHAIN_METRICS (
    TIMESTAMP TIMESTAMP_TZ,
    -- Block data
    BLOCK_HEIGHT INTEGER,
    TIME_SINCE_LAST_BLOCK STRING,
    BLOCK_SPEED FLOAT,
    BLOCKS_24HRS INTEGER,
    OUTPUTS_24HRS INTEGER,
    TOTAL_MINED_BLOCKS INTEGER,
    -- Transaction data
    TRANSACTIONS_PER_SECOND FLOAT,
    TRANSACTIONS_PER_BLOCK FLOAT,
    TRANSACTIONS_PER_DAY FLOAT,
    TRANSACTIONS_CURRENT_MONTH FLOAT,
    TOTAL_TRANSACTIONS_ALL_TIME INTEGER,
    -- UTXO metrics
    UTXOS_IN_PROFIT FLOAT,
    UTXOS_IN_LOSS FLOAT,
    UTXOS_IN_PROFIT_PCT FLOAT,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 3: Mining Metrics (Mining, difficulty, and hashrate)
CREATE OR REPLACE TABLE NEWHEDGE.MINING_METRICS (
    TIMESTAMP TIMESTAMP_TZ,
    -- Hashrate
    HASHRATE_EHS FLOAT,
    HASHPRICE_USD FLOAT,
    -- Difficulty
    PREVIOUS_DIFFICULTY FLOAT,
    PREVIOUS_DIFFICULTY_CHANGE_PCT FLOAT,
    CURRENT_DIFFICULTY FLOAT,
    NEXT_DIFFICULTY_ESTIMATE FLOAT,
    NEXT_DIFFICULTY_CHANGE_PCT FLOAT,
    NEXT_RETARGET STRING,
    EPOCH INTEGER,
    -- Rewards
    REWARD_PER_BLOCK_BTC FLOAT,
    REWARD_PER_BLOCK_USD FLOAT,
    REWARD_BTC_24HRS FLOAT,
    REWARD_USD_24HRS FLOAT,
    -- Revenue
    REVENUE_BTC_24H FLOAT,
    REVENUE_USD_24H FLOAT,
    -- Monthly totals
    CURRENT_MONTH_SUBSIDY_USD FLOAT,
    CURRENT_MONTH_FEES_USD FLOAT,
    CURRENT_MONTH_TOTAL_USD FLOAT,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 4: Fee Metrics
CREATE OR REPLACE TABLE NEWHEDGE.FEE_METRICS (
    TIMESTAMP TIMESTAMP_TZ,
    PER_TRANSACTION_SATS FLOAT,
    PER_TRANSACTION_USD FLOAT,
    FEES_BTC_24HRS FLOAT,
    FEES_USD_24HRS FLOAT,
    FEES_VS_REWARD_PCT FLOAT,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 5: Supply Metrics (Issuance and circulation)
CREATE OR REPLACE TABLE NEWHEDGE.SUPPLY_METRICS (
    TIMESTAMP TIMESTAMP_TZ,
    -- Circulating supply
    CIRCULATING_SUPPLY FLOAT,
    PERCENTAGE_ISSUED_PCT FLOAT,
    ISSUANCE_REMAINING FLOAT,
    ISSUANCE_BTC_24HRS FLOAT,
    -- Holder breakdown
    LONG_TERM_HOLDER_SUPPLY FLOAT,
    SHORT_TERM_HOLDER_SUPPLY FLOAT,
    SUPPLY_IN_PROFIT_PCT FLOAT,
    TOTAL_SUPPLY_IN_PROFIT FLOAT,
    TOTAL_SUPPLY_IN_LOSS FLOAT,
    -- Halving metrics
    PROJECTED_HALVING_DATE DATE,
    HALVING_BLOCK_HEIGHT INTEGER,
    BLOCKS_REMAINING INTEGER,
    BTC_UNTIL_HALVING FLOAT,
    CURRENT_EPOCH_PCT FLOAT,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 6: Holdings (Corporate and Government)
CREATE OR REPLACE TABLE NEWHEDGE.HOLDINGS (
    TIMESTAMP TIMESTAMP_TZ,
    -- Public companies
    PUBLIC_COMPANIES_COUNT INTEGER,
    PUBLIC_HOLDINGS_BTC FLOAT,
    PUBLIC_HOLDINGS_USD FLOAT,
    -- Private companies
    PRIVATE_COMPANIES_COUNT INTEGER,
    PRIVATE_HOLDINGS_BTC FLOAT,
    PRIVATE_HOLDINGS_USD FLOAT,
    -- Total corporate
    TOTAL_CORPORATE_BTC FLOAT,
    TOTAL_CORPORATE_USD FLOAT,
    CORPORATE_PCT_TOTAL_SUPPLY FLOAT,
    -- Government
    GOVERNMENTS_COUNT INTEGER,
    GOVERNMENT_TREASURY_BTC FLOAT,
    GOVERNMENT_TREASURY_USD FLOAT,
    GOVERNMENT_PCT_TOTAL_SUPPLY FLOAT,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 7: Trading Metrics (Exchange and volume data)
CREATE OR REPLACE TABLE NEWHEDGE.TRADING_METRICS (
    TIMESTAMP TIMESTAMP_TZ,
    -- BTC trading volume
    DAILY_BTC_TRADING_VOL_USD FLOAT,
    MONTHLY_BTC_TRADING_VOL_USD FLOAT,
    -- Exchange dominance
    BINANCE_DOMINANCE_PCT FLOAT,
    BTC_PAIRS_DOMINANCE_PCT FLOAT,
    -- Regional breakdown
    US_TRADING_VOL_USD FLOAT,
    US_TRADING_VOL_PCT FLOAT,
    OFFSHORE_TRADING_VOL_USD FLOAT,
    OFFSHORE_TRADING_VOL_PCT FLOAT,
    -- ETF metrics
    ETF_SPOT_TRADING_VOLUME FLOAT,
    ETF_FUTURES_TRADING_VOLUME FLOAT,
    ETF_TOTAL_SPOT_AUM FLOAT,
    ETF_TOTAL_BTC_HOLDINGS FLOAT,
    -- ETF holdings (major funds)
    IBIT_BLACKROCK_BTC FLOAT,
    FBTC_FIDELITY_BTC FLOAT,
    GBTC_GRAYSCALE_BTC FLOAT,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 8: Futures Open Interest (Exchange breakdown)
CREATE OR REPLACE TABLE NEWHEDGE.FUTURES_OPEN_INTEREST (
    TIMESTAMP TIMESTAMP_TZ,
    TOTAL_OPEN_INTEREST FLOAT,
    BINANCE_OI FLOAT,
    OKX_OI FLOAT,
    DERIBIT_OI FLOAT,
    BYBIT_OI FLOAT,
    BITMEX_OI FLOAT,
    BITGET_OI FLOAT,
    CRYPTOCOM_OI FLOAT,
    KUCOIN_OI FLOAT,
    GATEIO_OI FLOAT,
    HUOBI_OI FLOAT,
    BITFINEX_OI FLOAT,
    KRAKEN_OI FLOAT,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 9: Address Metrics (Distribution by balance)
CREATE OR REPLACE TABLE NEWHEDGE.ADDRESS_METRICS (
    TIMESTAMP TIMESTAMP_TZ,
    NEW_ADDRESSES INTEGER,
    BALANCE_1SAT_TO_001BTC INTEGER,
    BALANCE_001_TO_1BTC INTEGER,
    BALANCE_1_TO_10BTC INTEGER,
    BALANCE_10_TO_100BTC INTEGER,
    BALANCE_100_TO_1000BTC INTEGER,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 10: Address Distribution Detail (Price tiers)
CREATE OR REPLACE TABLE NEWHEDGE.ADDRESS_DISTRIBUTION (
    TIMESTAMP TIMESTAMP_TZ,
    CATEGORY STRING,
    TODAY STRING,
    CHANGE_1D STRING,
    CHANGE_1W STRING,
    CHANGE_1M STRING,
    CHANGE_1Y STRING,
    CHANGE_1Y_PCT STRING,
    PRIMARY KEY (TIMESTAMP, CATEGORY)
);

-- Table 11: Onchain Indicators (Technical metrics)
CREATE OR REPLACE TABLE NEWHEDGE.ONCHAIN_INDICATORS (
    TIMESTAMP TIMESTAMP_TZ,
    COIN_DAYS_DESTROYED FLOAT,
    MVRV_Z_SCORE FLOAT,
    NVT_RATIO FLOAT,
    RHODL_RATIO FLOAT,
    RESERVE_RISK FLOAT,
    VDD_MULTIPLE FLOAT,
    NET_REALIZED_PROFIT_LOSS FLOAT,
    NUPL FLOAT,
    ASOL FLOAT,
    MSOL FLOAT,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 12: Realized Price Metrics
CREATE OR REPLACE TABLE NEWHEDGE.REALIZED_PRICE (
    TIMESTAMP TIMESTAMP_TZ,
    REALIZED_PRICE_USD FLOAT,
    REALIZED_MARKETCAP_USD FLOAT,
    STH_REALIZED_PRICE_USD FLOAT,
    LTH_REALIZED_PRICE_USD FLOAT,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 13: Profitable Days Metrics
CREATE OR REPLACE TABLE NEWHEDGE.PROFITABLE_DAYS (
    TIMESTAMP TIMESTAMP_TZ,
    TOTAL_DAYS INTEGER,
    PROFITABLE_DAYS INTEGER,
    UNPROFITABLE_DAYS INTEGER,
    PERCENTAGE_PROFITABLE_PCT FLOAT,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 14: Macro & Liquidity Metrics
CREATE OR REPLACE TABLE NEWHEDGE.MACRO_LIQUIDITY (
    TIMESTAMP TIMESTAMP_TZ,
    -- Global M2
    GLOBAL_M2_SUPPLY FLOAT,
    GLOBAL_M2_GROWTH FLOAT,
    GLOBAL_M2_YOY_GROWTH_PCT FLOAT,
    GLOBAL_M2_10WEEK_LEAD FLOAT,
    -- US M2
    US_M2_SUPPLY FLOAT,
    FEDERAL_FUNDS_RATE_PCT FLOAT,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 15: Correlations (Asset correlations)
CREATE OR REPLACE TABLE NEWHEDGE.CORRELATIONS (
    TIMESTAMP TIMESTAMP_TZ,
    CORRELATION_SPX FLOAT,
    CORRELATION_GOLD FLOAT,
    CORRELATION_IWM FLOAT,
    CORRELATION_QQQ FLOAT,
    CORRELATION_TLT FLOAT,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 16: Gold Comparison
CREATE OR REPLACE TABLE NEWHEDGE.GOLD_COMPARISON (
    TIMESTAMP TIMESTAMP_TZ,
    GOLD_PRICE_USD FLOAT,
    GOLD_MARKETCAP_USD FLOAT,
    BTC_VS_GOLD_MARKETCAP_PCT FLOAT,
    GOLD_CORRELATION FLOAT,
    GOLD_SUPPLY_TONNES FLOAT,
    PRIMARY KEY (TIMESTAMP)
);

-- Table 17: Node Metrics (Geographic distribution)
CREATE OR REPLACE TABLE NEWHEDGE.NODE_METRICS (
    TIMESTAMP TIMESTAMP_TZ,
    TOTAL_NODES INTEGER,
    TOR_NODES INTEGER,
    TOR_NODES_PCT FLOAT,
    US_NODES INTEGER,
    GERMANY_NODES INTEGER,
    FRANCE_NODES INTEGER,
    CANADA_NODES INTEGER,
    FINLAND_NODES INTEGER,
    NETHERLANDS_NODES INTEGER,
    UK_NODES INTEGER,
    SWITZERLAND_NODES INTEGER,
    AUSTRALIA_NODES INTEGER,
    RUSSIA_NODES INTEGER,
    PRIMARY KEY (TIMESTAMP)
);



-- =====================================================
-- COMMENTS FOR DOCUMENTATION
-- =====================================================

COMMENT ON SCHEMA COINDESK IS 'Schema for CoinDesk API data including historical prices, news, and social metrics';
COMMENT ON SCHEMA NEWHEDGE IS 'Schema for NewHedge.io Bitcoin metrics including market, blockchain, and onchain indicators';

COMMENT ON TABLE NEWHEDGE.MARKET_DATA IS 'Core market data including price, market cap, performance, and fear & greed index';
COMMENT ON TABLE NEWHEDGE.BLOCKCHAIN_METRICS IS 'Blockchain network metrics including blocks, transactions, and UTXOs';
COMMENT ON TABLE NEWHEDGE.MINING_METRICS IS 'Mining metrics including hashrate, difficulty, and rewards';
COMMENT ON TABLE NEWHEDGE.SUPPLY_METRICS IS 'Bitcoin supply metrics including issuance, holder distribution, and halving data';
COMMENT ON TABLE NEWHEDGE.HOLDINGS IS 'Corporate and government Bitcoin holdings';
COMMENT ON TABLE NEWHEDGE.TRADING_METRICS IS 'Trading volume, exchange dominance, and ETF metrics';
COMMENT ON TABLE NEWHEDGE.ONCHAIN_INDICATORS IS 'Technical onchain indicators like MVRV, NVT, RHODL, etc.';
